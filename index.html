<!DOCTYPE html>
<html lang="zh-CN"> <!-- 设置页面的语言为简体中文 -->
<head>
  <meta charset="UTF-8" /> <!-- 设置字符编码为UTF-8 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- 设置视口，使页面适配各种设备 -->
  <title>随机多源视频播放 - Apple风格UI</title> <!-- 页面标题 -->
  <link rel="icon" href="favicon.ico" type="image/x-icon"> <!-- 设置页面的图标 -->

  <!-- DPlayer 样式 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css" /> <!-- 引入DPlayer播放器的CSS样式 -->

  <style>
    * {
      box-sizing: border-box; <!-- 设置所有元素的box-sizing为border-box，避免内外边距计算问题 -->
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; <!-- 设置字体为苹果系统字体 -->
      background: #f9f9fb; <!-- 背景颜色 -->
      color: #333; <!-- 字体颜色 -->
      margin: 0; <!-- 去除外边距 -->
      padding: 20px; <!-- 设置内边距 -->
      display: flex; <!-- 使用flexbox布局 -->
      justify-content: center; <!-- 设置主轴居中 -->
      align-items: flex-start; <!-- 设置交叉轴顶部对齐 -->
      min-height: 100vh; <!-- 设置最小高度为视口高度 -->
    }

    #recentBtn {
      width: 100%; <!-- 设置按钮宽度为100% -->
      margin-top: 12px; <!-- 设置按钮上边距 -->
      padding: 10px 0; <!-- 设置按钮内边距 -->
      font-size: 1rem; <!-- 设置字体大小 -->
      font-weight: 600; <!-- 设置字体加粗 -->
      background-color: #f0f0f0; <!-- 设置背景颜色 -->
      color: #333; <!-- 设置字体颜色 -->
      border: none; <!-- 去除边框 -->
      border-radius: 18px; <!-- 设置圆角 -->
      cursor: pointer; <!-- 设置鼠标样式为指针 -->
      user-select: none; <!-- 禁止文本选中 -->
      transition: background-color 0.2s ease; <!-- 设置背景颜色的过渡效果 -->
    }

    #recentBtn:hover {
      background-color: #e4e4e4; <!-- 设置按钮悬停时的背景颜色 -->
    }

    .container {
      background: #fff; <!-- 设置容器背景色 -->
      max-width: 95vw; <!-- 设置最大宽度为视口宽度的95% -->
      width: 480px; <!-- 设置容器宽度为480px -->
      border-radius: 16px; <!-- 设置容器圆角 -->
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); <!-- 设置阴影效果 -->
      padding: 20px 25px 30px; <!-- 设置容器的内边距 -->
      display: flex; <!-- 使用flexbox布局 -->
      flex-direction: column; <!-- 设置为纵向布局 -->
      align-items: center; <!-- 设置子元素居中 -->
      margin: 0 10px; <!-- 设置左右边距 -->
    }

    #apiSelect {
      width: 100%; <!-- 设置选择框宽度为100% -->
      margin-bottom: 12px; <!-- 设置下边距 -->
      padding: 8px; <!-- 设置内边距 -->
      border-radius: 12px; <!-- 设置圆角 -->
      border: 1px solid #ccc; <!-- 设置边框颜色 -->
      font-size: 1rem; <!-- 设置字体大小 -->
      background: #f9f9f9; <!-- 设置背景颜色 -->
    }

    h2#title {
      font-weight: 600; <!-- 设置字体加粗 -->
      font-size: 1.4rem; <!-- 设置字体大小 -->
      margin: 10px 0 15px; <!-- 设置上下边距 -->
      color: #111; <!-- 设置字体颜色 -->
      text-align: center; <!-- 设置文本居中 -->
      word-break: break-word; <!-- 设置文本换行 -->
    }

    #poster {
      width: 100%; <!-- 设置图片宽度为100% -->
      height: auto; <!-- 设置图片高度自动调整 -->
      border-radius: 14px; <!-- 设置圆角 -->
      display: block; <!-- 设置图片为块级元素 -->
      margin-bottom: 18px; <!-- 设置底部边距 -->
    }

    #info {
      width: 100%; <!-- 设置信息容器宽度为100% -->
      min-height: 100px; <!-- 设置最小高度 -->
    }

    #info p {
      margin: 4px 0; <!-- 设置段落的上下边距 -->
      font-size: 0.9rem; <!-- 设置字体大小 -->
      color: #555; <!-- 设置字体颜色 -->
      word-break: break-word; <!-- 设置文本换行 -->
    }

    #desc-wrapper {
      position: relative; <!-- 设置位置为相对 -->
      max-width: 100%; <!-- 设置最大宽度为100% -->
      margin-top: 4px; <!-- 设置顶部边距 -->
    }

    #description {
      display: -webkit-box; <!-- 使用webkit盒模型布局 -->
      -webkit-line-clamp: 2; <!-- 限制显示2行文本 -->
      -webkit-box-orient: vertical; <!-- 设置盒子方向为垂直 -->
      overflow: hidden; <!-- 超出部分隐藏 -->
      font-size: 0.9rem; <!-- 设置字体大小 -->
      color: #555; <!-- 设置字体颜色 -->
      transition: all 0.3s ease; <!-- 设置过渡效果 -->
      min-height: 2.5em; <!-- 设置最小高度 -->
    }

    #desc-wrapper.expanded #description {
      -webkit-line-clamp: unset; <!-- 展开时取消行数限制 -->
      overflow: visible; <!-- 展开时显示溢出部分 -->
    }

    #desc-toggle {
      background: none; <!-- 设置背景为透明 -->
      border: none; <!-- 去除边框 -->
      color: #007aff; <!-- 设置文字颜色 -->
      font-size: 0.85rem; <!-- 设置字体大小 -->
      cursor: pointer; <!-- 设置鼠标样式为指针 -->
      padding: 4px 0; <!-- 设置内边距 -->
      text-align: left; <!-- 设置文本左对齐 -->
      user-select: none; <!-- 禁止文本选中 -->
    }

    #episodeList {
      display: flex; <!-- 使用flexbox布局 -->
      flex-wrap: wrap; <!-- 允许换行 -->
      gap: 8px 12px; <!-- 设置间距 -->
      margin: 10px 0 20px; <!-- 设置外边距 -->
      width: 100%; <!-- 设置宽度为100% -->
    }

    #episodeList button {
      padding: 6px 12px; <!-- 设置按钮的内边距 -->
      border-radius: 12px; <!-- 设置按钮圆角 -->
      border: 1.2px solid #ccc; <!-- 设置边框 -->
      background: #f2f2f4; <!-- 设置背景色 -->
      font-size: 0.92rem; <!-- 设置字体大小 -->
      color: #333; <!-- 设置字体颜色 -->
      cursor: pointer; <!-- 设置鼠标样式为指针 -->
      transition: all 0.2s ease; <!-- 设置过渡效果 -->
      user-select: none; <!-- 禁止文本选中 -->
    }

    #episodeList button:hover {
      background-color: #e4e4e9; <!-- 设置悬停时背景颜色 -->
      border-color: #aaa; <!-- 设置悬停时边框颜色 -->
    }

    #episodeList button.active {
      background-color: #007aff; <!-- 设置激活时背景颜色 -->
      color: white; <!-- 设置激活时字体颜色 -->
      border-color: #007aff; <!-- 设置激活时边框颜色 -->
      box-shadow: 0 2px 6px rgba(0, 122, 255, 0.35); <!-- 设置激活时阴影 -->
    }

    #sourceList {
      width: 100%; <!-- 设置宽度为100% -->
      margin-bottom: 12px; <!-- 设置底部边距 -->
      display: flex; <!-- 使用flexbox布局 -->
      flex-wrap: wrap; <!-- 允许换行 -->
      gap: 8px 12px; <!-- 设置间距 -->
    }

    #sourceList button.source-btn {
      padding: 8px 15px; <!-- 设置按钮内边距 -->
      border-radius: 14px; <!-- 设置圆角 -->
      border: 1.5px solid #ddd; <!-- 设置边框颜色 -->
      background: #f6f6f8; <!-- 设置背景颜色 -->
      font-weight: 600; <!-- 设置字体加粗 -->
      cursor: pointer; <!-- 设置鼠标样式为指针 -->
      flex: 1 1 auto; <!-- 设置按钮的自动扩展 -->
      min-width: 80px; <!-- 设置最小宽度 -->
            text-align: center; <!-- 设置文本居中对齐 -->
      user-select: none; <!-- 禁止文本选中 -->
      transition: all 0.3s ease; <!-- 设置过渡效果 -->
    }

    #sourceList button.source-btn:hover {
      background: #e6e6eb; <!-- 设置按钮悬停时的背景颜色 -->
      border-color: #aaa; <!-- 设置悬停时的边框颜色 -->
    }

    #sourceList button.active {
      background: #007aff; <!-- 设置激活按钮的背景颜色 -->
      border-color: #007aff; <!-- 设置激活按钮的边框颜色 -->
      color: white; <!-- 设置激活按钮的字体颜色 -->
      box-shadow: 0 3px 8px rgba(0, 122, 255, 0.4); <!-- 设置激活按钮的阴影效果 -->
    }

    /* DPlayer容器样式 */
    #dplayer {
      width: 100%; <!-- 设置播放器容器宽度为100% -->
      aspect-ratio: 16 / 9; <!-- 设置播放器的宽高比为16:9 -->
      border-radius: 14px; <!-- 设置播放器的圆角 -->
      background: #000; <!-- 设置播放器背景色为黑色 -->
      margin-bottom: 20px; <!-- 设置底部边距 -->
      box-shadow: 0 6px 22px rgba(0, 0, 0, 0.12); <!-- 设置播放器的阴影效果 -->
      outline: none; <!-- 去除播放器的外边框 -->
      position: relative; <!-- 设置播放器为相对定位 -->
      color: #fff; <!-- 设置播放器的文字颜色 -->
      font-size: 1.1rem; <!-- 设置播放器字体大小 -->
      display: flex; <!-- 使用flex布局 -->
      justify-content: center; <!-- 设置内容水平居中 -->
      align-items: center; <!-- 设置内容垂直居中 -->
      text-align: center; <!-- 设置文本居中对齐 -->
      padding: 0 15px; <!-- 设置播放器内边距 -->
      user-select: none; <!-- 禁止选中内容 -->
    }

    #dplayer .dp-error-message {
      position: absolute; <!-- 设置错误信息为绝对定位 -->
      top: 50%; <!-- 设置错误信息垂直居中 -->
      left: 50%; <!-- 设置错误信息水平居中 -->
      transform: translate(-50%, -50%); <!-- 使用transform使错误信息完全居中 -->
      color: #f44336; <!-- 设置错误信息的字体颜色为红色 -->
      font-weight: 600; <!-- 设置错误信息的字体加粗 -->
    }

    #randomBtn {
      width: 100%; <!-- 设置按钮宽度为100% -->
      padding: 12px 0; <!-- 设置按钮内边距 -->
      font-size: 1.1rem; <!-- 设置按钮字体大小 -->
      font-weight: 700; <!-- 设置按钮字体加粗 -->
      background-color: #007aff; <!-- 设置按钮背景颜色 -->
      color: white; <!-- 设置按钮字体颜色 -->
      border: none; <!-- 去除按钮边框 -->
      border-radius: 18px; <!-- 设置按钮圆角 -->
      cursor: pointer; <!-- 设置鼠标样式为指针 -->
      user-select: none; <!-- 禁止文本选中 -->
      box-shadow: 0 6px 14px rgba(0, 122, 255, 0.5); <!-- 设置按钮阴影效果 -->
      transition: background-color 0.3s ease; <!-- 设置背景颜色过渡效果 -->
    }

    #randomBtn:hover {
      background-color: #005ecb; <!-- 设置按钮悬停时背景颜色 -->
    }

    #randomBtn:active {
      background-color: #004bb5; <!-- 设置按钮点击时背景颜色 -->
    }

    /* 响应式样式：当屏幕宽度小于等于480px时 */
    @media (max-width: 480px) {
      body {
        padding: 15px; <!-- 设置视口小于480px时的内边距 -->
      }

      .container {
        padding: 15px 18px 25px; <!-- 设置容器的内边距 -->
      }

      h2#title {
        font-size: 1.2rem; <!-- 设置标题字体大小 -->
      }

      #sourceList button.source-btn,
      #episodeList button {
        min-width: 70px; <!-- 设置按钮最小宽度 -->
        font-size: 0.95rem; <!-- 设置按钮字体大小 -->
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <select id="apiSelect" title="选择API接口"></select> <!-- API选择框 -->
    <h2 id="title">加载中...</h2> <!-- 视频标题 -->
    <img id="poster" src="" alt="视频封面" /> <!-- 视频封面图 -->

    <div id="info">
      <p><strong>演员：</strong><span id="actor"></span></p> <!-- 演员 -->
      <p><strong>导演：</strong><span id="director"></span></p> <!-- 导演 -->
      <p><strong>类型：</strong><span id="type"></span></p> <!-- 类型 -->
      <p><strong>发布时间：</strong><span id="pubdate"></span></p> <!-- 发布时间 -->
      <p><strong>简介：</strong></p>
      <div id="desc-wrapper">
        <div id="description">暂无简介</div> <!-- 简介 -->
        <button id="desc-toggle" onclick="toggleDescription()">展开</button> <!-- 展开/收起简介按钮 -->
      </div>
    </div>

    <div>
      <strong>集数列表：</strong>
      <br><strong>如果无法播放，请尝试其他视频线路</strong></br>
      <div id="episodeList"></div> <!-- 集数列表 -->
    </div>

    <div id="sourceList">播放线路：</div> <!-- 播放线路 -->

    <!-- DPlayer播放器容器 -->
    <div id="dplayer"></div>

    <button id="randomBtn" title="点击随机播放新视频">随机播放 🎲</button> <!-- 随机播放按钮 -->
    <button id="recentBtn" onclick="window.location.href='zuijin.html'">最近观看 🕘</button> <!-- 最近观看按钮 -->
  </div>

  <!-- 引入DPlayer和Hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script> <!-- HLS.js库 -->
  <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script> <!-- DPlayer播放器 -->

  <script>
    // 展开/收起简介
    function toggleDescription() {
      const wrapper = document.getElementById('desc-wrapper');
      const toggleBtn = document.getElementById('desc-toggle');
      const expanded = wrapper.classList.toggle('expanded');
      toggleBtn.innerText = expanded ? '收起' : '展开';
    }

    const titleEl = document.getElementById('title');
    const posterEl = document.getElementById('poster');
    const sourceListEl = document.getElementById('sourceList');
    const randomBtn = document.getElementById('randomBtn');
    const apiSelect = document.getElementById('apiSelect');

    const actorEl = document.getElementById('actor');
    const directorEl = document.getElementById('director');
    const typeEl = document.getElementById('type');
    const pubdateEl = document.getElementById('pubdate');
    const descriptionEl = document.getElementById('description');
    const episodeListEl = document.getElementById('episodeList');

    const ADD_INVALID_ID_API = 'api/add_invalid_id.php'; <!-- 无效ID添加API -->
    const GET_INVALID_IDS_API = 'api/get_invalid_ids.php'; <!-- 获取无效ID列表API -->

    let currentApiUrl = ''; <!-- 当前API地址 -->
    let currentApiName = ''; <!-- 当前API名称 -->
    let parseBaseUrl = ''; <!-- 解析基础URL -->
    let maxIdGlobal = 100000; <!-- 最大ID -->
    let invalidEntries = []; <!-- 无效ID数组 -->

    let dp = null; <!-- DPlayer实例 -->

    let currentEpisodes = []; <!-- 当前视频集数列表 -->
    let currentEpisodeIndex = 0; <!-- 当前集数索引 -->
    let currentLineIndex = 0; <!-- 当前播放线路索引 -->

    // 获取API列表
    async function fetchApiList() {
      try {
        const res = await fetch('api/list_apis.php'); <!-- 获取API列表 -->
        const json = await res.json();
        parseBaseUrl = json.parse_url;

        apiSelect.innerHTML = ''; <!-- 清空API选择框 -->
        json.apis.forEach(api => {
          const opt = document.createElement('option');
          opt.value = api.api_url;
          opt.text = api.name;
          apiSelect.appendChild(opt); <!-- 填充API选择框 -->
        });

        currentApiUrl = apiSelect.value; <!-- 设置当前API地址 -->
        currentApiName = apiSelect.options[apiSelect.selectedIndex].text; <!-- 设置当前API名称 -->

        // 当选择API时重新加载数据
        apiSelect.onchange = () => {
          currentApiUrl = apiSelect.value;
          currentApiName = apiSelect.options[apiSelect.selectedIndex].text;
          initMaxId();
        };

        initMaxId(); <!-- 初始化最大ID -->
      } catch (err) {
        console.error('Failed to fetch API list:', err);
      }
    }
  </script>
</body>
</html>

